<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="bootstrap_v3/docs-assets/ico/favicon.png">

    <title>Charles County DPW</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap_v3/dist/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="fullmap-template.css" rel="stylesheet">

    <!-- Bootstrap-map-js -->
    <link rel="stylesheet" type="text/css" href="http://js.arcgis.com/3.8/js/esri/css/esri.css">
    <link rel="stylesheet" type="text/css" href="src/css/bootstrapmap.css">
    <link rel="stylesheet" type="text/css" href="src/css/style.css">

    <link rel="stylesheet" type="text/css" href="http://js.arcgis.com/3.8/js/dojo/dijit/themes/claro/claro.css">

    <style type="text/css">
      #mapDiv {
        min-height: 100%;
        max-height: 100%; 
      }
    </style>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="/bootstrap_v3/docs-assets/js/html5shiv.js"></script>
      <script src="/bootstrap_v3/docs-assets/js/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
  <body class="override">
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#"><img class="navbar-brand-image" src="src/images/CC_Logo.png"/> Charles County DPW</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <!--li class="active"><a href="#">Basemaps</a></li-->
            <li class="active dropdown" id="basemapList">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Basemaps <b class="caret"></b></a>
              <ul class="dropdown-menu" id="myDropdown">
                <li><a href="#">Charles Basemap</a></li>
                <li><a href="#">iMap Orthophoto</a></li>
              </ul>
            </li>
              <li class="active dropdown" id="layerList">
                  <a href class="dropdown-toggle" data-toggle="dropdown">Layers <b class="caret"></b></a>
                  <ul class="dropdown-menu" id="myDropdown2">
                      <li id="contours" value="4" title="off" class="list_item">
                          <a href="#">Fiber Telecom</a>
                      </li>
                      <li class="divider"></li>
                      <li id="geology" value="7" title="on" class="list_item">
                          <a href="#">Water</a>
                      </li>
                      <li class="divider"></li>
                      <li id="Wastewater" value="8" title="off" class="list_item">
                          <a href="#">Wastewater</a>
                      </li>
                      <li class="divider"></li>
                      <li id="Property" value="8" title="off" class="list_item">
                          <a href="#">Property</a>
                      </li>
                  </ul>
              </li>
            <li id="aboutNav"><a href="#about">About</a></li>
            <li id="zoomFull"><a href="#zoomfull">Zoom to Full Map</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="modal fade" id="aboutModal" style="display: none;" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                    <h4 class="modal-title">About</h4>
                </div>
                <div class="modal-body">
                    <p>
                        Charles County, Maryland Department of Public Works
                    <p>
                        This simple template was built with ArcGIS API for
                        Javascript and Bootstrap 3.0.  It is designed to display on most browsers and screen sizes,
                        and optimized for touch screen devices.
                    </p>
                    <br>
                    <p>
                        Data courtesy of DigitalGlobe, FEMA, ESRI, and OpenStreetMap.
                    </p>
                    <br>
                    <p>
                        Bootstrap Map JS           <br>
                        Copyright 2013 Esri
                    </p>
                    <br>
                    <p>
                        Licensed under the Apache License, Version 2.0 (the "License");
                        you may not use this file except in compliance with the License.
                        You may obtain a copy of the License at  http://www.apache.org/licenses/LICENSE-2.0
                    </p>
                    <br>
                    <p>
                        Unless required by applicable law or agreed to in writing, software
                        distributed under the License is distributed on an "AS IS" BASIS,
                        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
                        See the License for the specific language governing permissions and
                        limitations under the License.
                    </p>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!-- Bootstrap-map-js -->
    <div id="mapDiv">
        <div id="LocateButton"></div>
    </div>

    <script src="http://js.arcgis.com/3.8compact"></script>
    <script>
        require(["esri/map",
            "esri/dijit/Scalebar",
            "esri/dijit/LocateButton",
            "src/js/bootstrapmap.js",
            "dojo/json",
            "dojo/store/Memory",
            "esri/arcgis/utils",
            "dojo/text!./AddLayersPopupTemplates.js",
            "esri/layers/FeatureLayer",
            "esri/IdentityManager",
            "dojo/domReady!"],
          function(Map, Scalebar, LocateButton, BootstrapMap, json, Memory, esriUtils, popupTemplate, pathToJson, FeatureLayer) {
            <!-- Get a reference to the ArcGIS Map class -->

              var map;
              var scalebar;
              var legend;

              // Load web map when page loads
              loadWebmap();

              function loadWebmap(e) {
                  // Get new webmap and extract map and map parts
                  var mapDeferred = esriUtils.createMap("8adce38ca6ac4641a5601d02edeb3315", "mapDiv", {
                      mapOptions: {
                          slider: true,
                          nav:false,
                          smartNavigation:false
                      }
                  });

                  mapDeferred.then(function(response) {
                      map = response.map;

                      geoLocate = new LocateButton({
                          map: map
                      }, "LocateButton");
                      geoLocate.startup();

                      // Bind to map
                      BootstrapMap.bindTo(map);

                      /*
                      // Add titles
                      dom.byId("mapTitle").innerHTML = response.itemInfo.item.title;
                      //dom.byId("mapSubTitle").innerHTML = response.itemInfo.item.snippet;
                      // Add scalebar and legend
                      var layers = esri.arcgis.utils.getLegendLayers(response);
                      if(map.loaded){


                          initMapParts(layers);
                      }
                      else{
                          on(map,"load",function(){
                              initMapParts(layers);
                          });
                      }*/

                  },function(error){
                      alert("Sorry, couldn't load webmap!");
                      console.log("Error loading webmap: " & dojo.toJson(error));
                  });
              }

              function initMapParts(layers){
                  //add scalebar
                  scalebar = new Scalebar({
                      map:map,
                      scalebarUnit: 'english'
                  });



                  //add legend
                  if (legend) {
                      legend.map = map;
                      legend.refresh(layers);
                  }
                  else {
                      legend = new Legend({
                          map:map,
                          layerInfos:layers
                      },"mapLegendDiv");
                      legend.startup();
                  }
              }

              // Show modal dialog, hide nav, toggle layers
              $(document).ready(function(){
                  $('#basemapList li').click(function(e) {
                      switch (e.target.text) {
                          case "Open Street Map":
                              map.setBasemap("osm");
                              setPreEvent(false);
                              setPostEvent(false);
                              break;
                          case "Pre Event Imagery":
                              removeOSM(false);
                              setPreEvent(true);
                              setPostEvent(false);
                              break;
                          case "Post Event Imagery":
                              removeOSM(false);
                              setPreEvent(false);
                              setPostEvent(true);
                              break;
                      }
                      if ($(".navbar-collapse.in").length > 0) {
                          $(".navbar-toggle").click();
                      }
                  });
                  $('#layerList li').click(function(e){
                      switch (e.target.text){
                          case "Water":
                              toggleLayer("Charles_Utilities_Water_7158");
                              break;
                          case "Wastewater":
                              toggleLayer("Charles_Utilities_Wastewater_2309");
                              break;
                          case "Fiber Telecom":
                              addServiceLayer();
                              break;
                      }
                      if ($(".navbar-collapse.in").length > 0) {
                          $(".navbar-toggle").click();
                      }
                  })
                  /*               // Close menu
                   $('.nav a').on('click', function(){
                   $(".navbar-toggle").click();
                   });*/
                  // Contact nav menu is selected
                  $("#contactNav").click(function(e){
                      $("#contactModal").modal("show");
                      // Bootstrap work-around
                      $("body").css("margin-right","0px");
                      $(".navbar").css("margin-right","0px");
                  });
                  // About nav menu is selected
                  $("#aboutNav").click(function(e){
                      $("#aboutModal").modal("show");
                      // Bootstrap work-around
                      $("body").css("margin-right","0px");
                      $(".navbar").css("margin-right","0px");
                  });
                  $("#zoomFull").click(function(e){
                      zoomFullMap();
                      // Bootstrap work-around
                      $("body").css("margin-right","0px");
                      $(".navbar").css("margin-right","0px");
                  });

              });

              function setCharlesBasemap(val){
                  var graphicsLayers = map.layerIds;
                  var mapLayer;
                  for (var i = 0; i < graphicsLayers.length; i++) {
                      var layername = graphicsLayers[i];
                      var layer = map.getLayer(layername);
                      if (layer.id === "Charles_Utilities_Wastewater_2309") {
                          mapLayer = layer;
                          mapLayer.setVisibility(val)
                      }
                  }
              }

              function addServiceLayer(){
                  //Add a Map Service layer to the map
                  //Make a request to get the new JSON object of layers
/*                  var jsonRequest = esri.request({
                      url: "/src/js/AddLayers.js",
                      content: { f: "json" },
                      handleAs: "json",
                      callbackParamName: "callback"
                  });*/

                  var ServiceURL = "https://prod1.spatialsys.com/arcgis/rest/services/CharlesUtilities/Charles_Utilities_FiberComm/MapServer"
                  var layer;
                      layer = new esri.layers.ArcGISDynamicMapServiceLayer(ServiceURL);

                  var requestHandle = esri.request({
                      "url": ServiceURL,
                      "content": {
                          "f": "json"
                      },
                      "callbackParamName": "callback"
                  });
                  requestHandle.then(function RequestSucceeded(response){
                      var layerInfo
                              // show layer indexes and names
                              if ( response.hasOwnProperty("layers") ) {
                                  console.log("got some layers");
                                  layerInfo = dojo.map(response.layers, function(f) {
                                      return (f.id);
                                  });

                                  for (var j = 0; j < layerInfo.length; j++) {
                                      var popupTemplateStore = new Memory({
                                          idProperty: "ID",
                                          data: json.parse(popupTemplate)
                                      });

                                      var TemplatefromJson = popupTemplateStore.get(layerInfo[j]);
                                      var PopupTemplate = new esri.dijit.PopupTemplate({
                                          title: TemplatefromJson.popupInfo.title,
                                          fieldInfos: TemplatefromJson.popupInfo.fieldInfos,
                                          showAttachments: TemplatefromJson.popupInfo.showAttachments,
                                          description: TemplatefromJson.popupInfo.description,
                                          mediaInfos: TemplatefromJson.popupInfo.mediaInfos
                                      })

                                      //create the feature layer and apply the popup template
                                      var fL = new esri.layers.FeatureLayer(ServiceURL + "/" + layerInfo[j], {
                                          mode: esri.layers.FeatureLayer.MODE_ONDEMAND,
                                          outFields: ["*"],
                                          infoTemplate: PopupTemplate
                                      });
                                      map.addLayer(fL);
                                      /*                      //create the feature layer and apply the popup template
                                       var fL = new esri.layers.FeatureLayer(item.url + "/" + layer.serviceInfo.layers[j].id, {
                                       mode: 2,
                                       layerId: layer.serviceInfo.layers[j].id,
                                       id: item.id + "_" + layer.serviceInfo.layers[j].id,
                                       infoTemplate: PopupTemplate,
                                       outFields: ["*"]
                                       });
                                       this.map.addLayer(fL);*/

                                  }

                              } else {
                                  //dojo.byId("content").value = "No layer info found. Please double-check the URL.";
                              }

                          }
                          , function requestFailed(){
                              console.log("Request Failed")
                          });




  /*                var TemplatefromJson = popupTemplateStore.get(layer.serviceInfo.layers[j].id);

                  var PopupTemplate = new esri.dijit.PopupTemplate({
                      title: TemplatefromJson.popupInfo.title,
                      fieldInfos: TemplatefromJson.popupInfo.fieldInfos,
                      showAttachments: TemplatefromJson.popupInfo.showAttachments,
                      description: TemplatefromJson.popupInfo.description,
                      mediaInfos: TemplatefromJson.popupInfo.mediaInfos
                  })

                                  //create the feature layer and apply the popup template
                                  var fL = new FeatureLayer(layer.url + "/" + layer.serviceInfo.layers[j].id, {
                                      mode: 2,
                                      layerId: layer.serviceInfo.layers[j].id,
                                      id: Charles_Utilities_FiberComm + "_" + layer.serviceInfo.layers[j].id,
                                      infoTemplate: PopupTemplate,
                                      outFields: ["*"]
                                  });
                                  this.map.addLayer(fL);

       *//*               //sjh testing
                      //Set the title for Legend to use.
                      layer.title = item.name;
                      //Take on the REST endpoint's serviceinfo JSON. Legend can then check for it and use it.
                      layer.serviceInfo = node.serviceInfo;*//*

                      //Make sure the layer loads, or show the error, should be converted to layer's load event
*//*                      connect.connect(map, "onLayerAddResult", lang.hitch(this, function (layer, error) {
                          if (error)
                              alert("Error occurred loading in map : " + error.message);
                          this._paneStandby.hide();
                      }));*//*
                      this.map.addLayer(layer);
                      this.map.addLayer(fL);*/
                      //sjh testing

                 }


              function setImagery(val){
                  var graphicsLayers = map.layerIds;
                  var mapLayer;
                  for (var i = 0; i < graphicsLayers.length; i++) {
                      var layername = graphicsLayers[i];
                      var layer = map.getLayer(layername);
                      if (layer.id === "Charles_Utilities_Water_7158") {
                          mapLayer = layer;
                          mapLayer.setVisibility(val)
                      }
                  }
              }


              function zoomFullMap(){
                  var startExtent = new esri.geometry.Extent(-77.27, 38.25,-76.64, 38.726);
                  map.setExtent(startExtent);
              }



              function toggleLayer(inputName){
                  var graphicsLayers = map.layerIds;
                  var mapLayer;
                  for (var i = 0; i < graphicsLayers.length; i++) {
                      var layername = graphicsLayers[i];
                      var layer = map.getLayer(layername);
                      if (layer.id === inputName) {
                          mapLayer = layer;
                          var vis = mapLayer.visible;
                          if (vis) {
                              mapLayer.setVisibility(false);
                          }  else  {
                              mapLayer.setVisibility(true);
                          }


                      }
                  }
              }

              function toggleGraphicsLayer(inputName) {
                  var graphicsLayers = map.graphicsLayerIds;
                  var mapLayer;
                  for (var i = 0; i < graphicsLayers.length; i++) {
                      var layername = graphicsLayers[i];
                      var layer = map.getLayer(layername);
                      if (layer.id === inputName) {
                          mapLayer = layer;
                          var vis = mapLayer.visible;
                          if (vis) {
                              mapLayer.setVisibility(false);
                          }  else  {
                              mapLayer.setVisibility(true);
                          }
                      }
                  }
              }


        });

    </script>

 



    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="bootstrap_v3/docs-assets/js/jquery.js"></script>
    <script src="bootstrap_v3/dist/js/bootstrap.min.js"></script>
  </body>
</html>
